<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controller Manager &mdash; Franka Control Interface (FCI) 0.6.0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/style_override.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> Franka Control Interface (FCI)
            <img src="../../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.6
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../requirements.html">Minimum system and network requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../compatibility.html">Compatible versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation_linux.html">Installation on Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../libfranka.html">libfranka</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../franka_ros.html">franka_ros</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/index.html">franka_ros2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../franka_toolbox_for_matlab/docs/franka_matlab/index.html">Franka Toolbox for MATLAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../control_parameters.html">Robot and interface specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fr3-certification-remarks.html">FR3 certification remarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">FAQ</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Franka Control Interface (FCI)</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Controller Manager</li>
      <li class="wy-breadcrumbs-aside">
              <!-- User defined GitHub URL -->
              <a href="https://github.com/ros-controls/ros2_control/blob/{REPOS_FILE_BRANCH}/controller_manager/doc/userdoc.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="controller-manager">
<span id="controller-manager-userdoc"></span><h1>Controller Manager<a class="headerlink" href="#controller-manager" title="Permalink to this heading"></a></h1>
<p>Controller Manager is the main component in the ros2_control framework.
It manages lifecycle of controllers, access to the hardware interfaces and offers services to the ROS-world.</p>
<section id="determinism">
<h2>Determinism<a class="headerlink" href="#determinism" title="Permalink to this heading"></a></h2>
<p>For best performance when controlling hardware you want the controller manager to have as little jitter as possible in the main control loop.</p>
<p>Independent of the kernel installed, the main thread of Controller Manager attempts to
configure <code class="docutils literal notranslate"><span class="pre">SCHED_FIFO</span></code> with a priority of <code class="docutils literal notranslate"><span class="pre">50</span></code>. Read more about the scheduling policies
<a class="reference external" href="https://blogs.oracle.com/linux/post/task-priority">for example here</a>.</p>
<p>For real-time tasks, a priority range of 0 to 99 is expected, with higher numbers indicating higher priority. By default, users do not have permission to set such high priorities.
To give the user such permissions, add a group named realtime and add the user controlling your robot to this group:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo<span class="w"> </span>addgroup<span class="w"> </span>realtime
<span class="gp">$ </span>sudo<span class="w"> </span>usermod<span class="w"> </span>-a<span class="w"> </span>-G<span class="w"> </span>realtime<span class="w"> </span><span class="k">$(</span>whoami<span class="k">)</span>
</pre></div>
</div>
<p>Afterwards, add the following limits to the realtime group in <code class="docutils literal notranslate"><span class="pre">/etc/security/limits.conf</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">@realtime soft rtprio 99</span>
<span class="go">@realtime soft priority 99</span>
<span class="go">@realtime soft memlock unlimited</span>
<span class="go">@realtime hard rtprio 99</span>
<span class="go">@realtime hard priority 99</span>
<span class="go">@realtime hard memlock unlimited</span>
</pre></div>
</div>
<p>The limits will be applied after you log out and in again.</p>
<p>You can run ros2_control with real-time requirements also from a docker container. Pass the following capability options to allow the container to set the thread priority and lock memory, e.g.,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--cap-add<span class="o">=</span>sys_nice<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--ulimit<span class="w"> </span><span class="nv">rtprio</span><span class="o">=</span><span class="m">99</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--ulimit<span class="w"> </span><span class="nv">memlock</span><span class="o">=</span>-1<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--rm<span class="w"> </span>--net<span class="w"> </span>host<span class="w"> </span>&lt;IMAGE&gt;
</pre></div>
</div>
<p>For more information, see the Docker engine documentation about <a class="reference external" href="https://docs.docker.com/engine/containers/resource_constraints/#configure-the-real-time-scheduler">resource_constraints</a> and <a class="reference external" href="https://docs.docker.com/engine/containers/run/#runtime-privilege-and-linux-capabilities">linux capabilities</a>.</p>
<p>The normal linux kernel is optimized for computational throughput and therefore is not well suited for hardware control.
Alternatives to the standard kernel include</p>
<ul class="simple">
<li><p><a class="reference external" href="https://ubuntu.com/real-time">Real-time Ubuntu</a> on Ubuntu (also for RaspberryPi)</p></li>
<li><p><a class="reference external" href="https://packages.debian.org/search?searchon=names&amp;keywords=linux-image-rt-amd64">linux-image-rt-amd64</a> or <a class="reference external" href="https://packages.debian.org/search?suite=default&amp;section=all&amp;arch=any&amp;searchon=names&amp;keywords=linux-image-rt-arm64">linux-image-rt-arm64</a> on Debian for 64-bit PCs</p></li>
<li><p><a class="reference external" href="https://ubuntu.com/blog/industrial-embedded-systems">lowlatency kernel</a> (<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt</span> <span class="pre">install</span> <span class="pre">linux-lowlatency</span></code>) on any Ubuntu</p></li>
</ul>
<p>Though installing a realtime-kernel will definitely get the best results when it comes to low
jitter, using a lowlatency kernel can improve things a lot with being really easy to install.</p>
</section>
<section id="publishers">
<h2>Publishers<a class="headerlink" href="#publishers" title="Permalink to this heading"></a></h2>
<dl class="simple">
<dt>~/activity [controller_manager_msgs::msg::ControllerManagerActivity]</dt><dd><p>A topic that is published every time there is a change of state of the controllers or hardware components managed by the controller manager.
The message contains the list of the controllers and the hardware components that are managed by the controller manager along with their lifecycle states.
The topic is published using the “transient local” quality of service, so subscribers should also be “transient local”.</p>
</dd>
</dl>
</section>
<section id="subscribers">
<h2>Subscribers<a class="headerlink" href="#subscribers" title="Permalink to this heading"></a></h2>
<dl class="simple">
<dt>robot_description [std_msgs::msg::String]</dt><dd><p>String with the URDF xml, e.g., from <code class="docutils literal notranslate"><span class="pre">robot_state_publisher</span></code>.
Reloading of the URDF is not supported yet.
All joints defined in the <code class="docutils literal notranslate"><span class="pre">&lt;ros2_control&gt;</span></code>-tag have to be present in the URDF.</p>
</dd>
</dl>
</section>
<section id="parameters">
<h2>Parameters<a class="headerlink" href="#parameters" title="Permalink to this heading"></a></h2>
<dl class="simple">
<dt>&lt;controller_name&gt;.type</dt><dd><p>Name of a plugin exported using <code class="docutils literal notranslate"><span class="pre">pluginlib</span></code> for a controller.
This is a class from which controller’s instance with name “<code class="docutils literal notranslate"><span class="pre">controller_name</span></code>” is created.</p>
</dd>
<dt>&lt;controller_name&gt;.params_file</dt><dd><p>The absolute path to the YAML file with parameters for the controller.
The file should contain the parameters for the controller in the standard ROS 2 YAML format.</p>
</dd>
<dt>&lt;controller_name&gt;.fallback_controllers</dt><dd><p>List of controllers that are activated as a fallback strategy, when the spawned controllers fail by returning <code class="docutils literal notranslate"><span class="pre">return_type::ERROR</span></code> during the <code class="docutils literal notranslate"><span class="pre">update</span></code> cycle.
It is recommended to add all the controllers needed for the fallback strategy to the list, including the chainable controllers whose interfaces are used by the main fallback controllers.</p>
</dd>
</dl>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The fallback controllers activation is subject to the availability of the state and command interfaces at the time of activation.
It is recommended to test the fallback strategy in simulation before deploying it on the real robot.</p>
</div>
<p><strong>An example parameter file:</strong></p>
</section>
<section id="handling-multiple-controller-managers">
<h2>Handling Multiple Controller Managers<a class="headerlink" href="#handling-multiple-controller-managers" title="Permalink to this heading"></a></h2>
<p>When dealing with multiple controller managers, you have two options for managing different robot descriptions:</p>
<ol class="arabic simple">
<li><p><strong>Using Namespaces:</strong> You can place both the <code class="docutils literal notranslate"><span class="pre">robot_state_publisher</span></code> and the <code class="docutils literal notranslate"><span class="pre">controller_manager</span></code> nodes into the same namespace.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">control_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="s2">&quot;controller_manager&quot;</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;ros2_control_node&quot;</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">robot_controllers</span><span class="p">],</span>
    <span class="n">output</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span>
    <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;rrbot&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">robot_state_pub_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="s2">&quot;robot_state_publisher&quot;</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;robot_state_publisher&quot;</span><span class="p">,</span>
    <span class="n">output</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">robot_description</span><span class="p">],</span>
    <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;rrbot&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p><strong>Using Remappings:</strong> You can use remappings to handle different robot descriptions. This involves relaying topics using the <code class="docutils literal notranslate"><span class="pre">remappings</span></code> tag, allowing you to specify custom topics for each controller manager.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">control_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="s2">&quot;controller_manager&quot;</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;ros2_control_node&quot;</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">robot_controllers</span><span class="p">],</span>
    <span class="n">output</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span>
    <span class="n">remappings</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;robot_description&#39;</span><span class="p">,</span> <span class="s1">&#39;/rrbot/robot_description&#39;</span><span class="p">)]</span>
<span class="p">)</span>
<span class="n">robot_state_pub_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="s2">&quot;robot_state_publisher&quot;</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;robot_state_publisher&quot;</span><span class="p">,</span>
    <span class="n">output</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">robot_description</span><span class="p">],</span>
    <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;rrbot&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="helper-scripts">
<h2>Helper scripts<a class="headerlink" href="#helper-scripts" title="Permalink to this heading"></a></h2>
<p>There are two scripts to interact with controller manager from launch files:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">spawner</span></code> - loads, configures and start a controller on startup.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unspawner</span></code> - stops and unloads a controller.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hardware_spawner</span></code> - activates and configures a hardware component.</p></li>
</ol>
</div></blockquote>
<section id="spawner">
<h3><code class="docutils literal notranslate"><span class="pre">spawner</span></code><a class="headerlink" href="#spawner" title="Permalink to this heading"></a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ros2<span class="w"> </span>run<span class="w"> </span>controller_manager<span class="w"> </span>spawner<span class="w"> </span>-h
<span class="go">usage: spawner [-h] [-c CONTROLLER_MANAGER] [-p PARAM_FILE] [-n NAMESPACE] [--load-only] [--inactive] [-u] [--controller-manager-timeout CONTROLLER_MANAGER_TIMEOUT]</span>
<span class="go">              [--switch-timeout SWITCH_TIMEOUT] [--activate-as-group] [--service-call-timeout SERVICE_CALL_TIMEOUT] [--controller-ros-args CONTROLLER_ROS_ARGS]</span>
<span class="go">              controller_names [controller_names ...]</span>

<span class="go">positional arguments:</span>
<span class="go">  controller_names      List of controllers</span>

<span class="go">options:</span>
<span class="go">  -h, --help            show this help message and exit</span>
<span class="go">  -c CONTROLLER_MANAGER, --controller-manager CONTROLLER_MANAGER</span>
<span class="go">                        Name of the controller manager ROS node</span>
<span class="go">  -p PARAM_FILE, --param-file PARAM_FILE</span>
<span class="go">                        Controller param file to be loaded into controller node before configure. Pass multiple times to load different files for different controllers or to override the parameters of the same controller.</span>
<span class="go">  -n NAMESPACE, --namespace NAMESPACE</span>
<span class="go">                        DEPRECATED Namespace for the controller_manager and the controller(s)</span>
<span class="go">  --load-only           Only load the controller and leave unconfigured.</span>
<span class="go">  --inactive            Load and configure the controller, however do not activate them</span>
<span class="go">  -u, --unload-on-kill  Wait until this application is interrupted and unload controller</span>
<span class="go">  --controller-manager-timeout CONTROLLER_MANAGER_TIMEOUT</span>
<span class="go">                        Time to wait for the controller manager service to be available</span>
<span class="go">  --service-call-timeout SERVICE_CALL_TIMEOUT</span>
<span class="go">                        Time to wait for the service response from the controller manager</span>
<span class="go">  --switch-timeout SWITCH_TIMEOUT</span>
<span class="go">                        Time to wait for a successful state switch of controllers. Useful if controllers cannot be switched immediately, e.g., paused</span>
<span class="go">                        simulations at startup</span>
<span class="go">  --activate-as-group   Activates all the parsed controllers list together instead of one by one. Useful for activating all chainable controllers altogether</span>
<span class="go">  --controller-ros-args CONTROLLER_ROS_ARGS</span>
<span class="go">                        The --ros-args to be passed to the controller node for remapping topics etc</span>
</pre></div>
</div>
<p>The parsed controller config file can follow the same conventions as the typical ROS 2 parameter file format. Now, the spawner can handle config files with wildcard entries and also the controller name in the absolute namespace. See the following examples on the config files:</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">/**</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ros__parameters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">joint_trajectory_controller/JointTrajectoryController</span>

<span class="w">    </span><span class="nt">command_interfaces</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">position</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">.....</span>

<span class="nt">position_trajectory_controller_joint1</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ros__parameters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">joints</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">joint1</span>

<span class="nt">position_trajectory_controller_joint2</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ros__parameters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">joints</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">joint2</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">/**/position_trajectory_controller</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ros__parameters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">joint_trajectory_controller/JointTrajectoryController</span>
<span class="w">    </span><span class="nt">joints</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">joint1</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">joint2</span>

<span class="w">    </span><span class="nt">command_interfaces</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">position</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">.....</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">/position_trajectory_controller</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ros__parameters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">joint_trajectory_controller/JointTrajectoryController</span>
<span class="w">    </span><span class="nt">joints</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">joint1</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">joint2</span>

<span class="w">    </span><span class="nt">command_interfaces</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">position</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">.....</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">position_trajectory_controller</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ros__parameters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">joint_trajectory_controller/JointTrajectoryController</span>
<span class="w">    </span><span class="nt">joints</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">joint1</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">joint2</span>

<span class="w">    </span><span class="nt">command_interfaces</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">position</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">.....</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">/rrbot_1/position_trajectory_controller</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ros__parameters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">joint_trajectory_controller/JointTrajectoryController</span>
<span class="w">    </span><span class="nt">joints</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">joint1</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">joint2</span>

<span class="w">    </span><span class="nt">command_interfaces</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">position</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">.....</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="unspawner">
<h3><code class="docutils literal notranslate"><span class="pre">unspawner</span></code><a class="headerlink" href="#unspawner" title="Permalink to this heading"></a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ros2<span class="w"> </span>run<span class="w"> </span>controller_manager<span class="w"> </span>unspawner<span class="w"> </span>-h
<span class="go">usage: unspawner [-h] [-c CONTROLLER_MANAGER] [--switch-timeout SWITCH_TIMEOUT] controller_names [controller_names ...]</span>

<span class="go">positional arguments:</span>
<span class="go">  controller_names      Name of the controller</span>

<span class="go">options:</span>
<span class="go">  -h, --help            show this help message and exit</span>
<span class="go">  -c CONTROLLER_MANAGER, --controller-manager CONTROLLER_MANAGER</span>
<span class="go">                        Name of the controller manager ROS node</span>
<span class="go">  --switch-timeout SWITCH_TIMEOUT</span>
<span class="go">                        Time to wait for a successful state switch of controllers. Useful if controllers cannot be switched immediately, e.g., paused</span>
<span class="go">                        simulations at startup</span>
</pre></div>
</div>
</section>
<section id="hardware-spawner">
<h3><code class="docutils literal notranslate"><span class="pre">hardware_spawner</span></code><a class="headerlink" href="#hardware-spawner" title="Permalink to this heading"></a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ros2<span class="w"> </span>run<span class="w"> </span>controller_manager<span class="w"> </span>hardware_spawner<span class="w"> </span>-h
<span class="go">usage: hardware_spawner [-h] [-c CONTROLLER_MANAGER] [--controller-manager-timeout CONTROLLER_MANAGER_TIMEOUT]</span>
<span class="go">                        (--activate | --configure)</span>
<span class="go">                        hardware_component_names [hardware_component_names ...]</span>

<span class="go">positional arguments:</span>
<span class="go">  hardware_component_names</span>
<span class="go">                        The name of the hardware components which should be activated.</span>

<span class="go">options:</span>
<span class="go">  -h, --help            show this help message and exit</span>
<span class="go">  -c CONTROLLER_MANAGER, --controller-manager CONTROLLER_MANAGER</span>
<span class="go">                        Name of the controller manager ROS node</span>
<span class="go">  --controller-manager-timeout CONTROLLER_MANAGER_TIMEOUT</span>
<span class="go">                        Time to wait for the controller manager</span>
<span class="go">  --activate            Activates the given components. Note: Components are by default configured before activated.</span>
<span class="go">  --configure           Configures the given components.</span>
</pre></div>
</div>
</section>
</section>
<section id="rqt-controller-manager">
<h2>rqt_controller_manager<a class="headerlink" href="#rqt-controller-manager" title="Permalink to this heading"></a></h2>
<p>A GUI tool to interact with the controller manager services to be able to switch the lifecycle states of the controllers as well as the hardware components.</p>
<img alt="../../../_images/rqt_controller_manager.png" src="../../../_images/rqt_controller_manager.png" />
<p>It can be launched independently using the following command or as rqt plugin:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 run rqt_controller_manager rqt_controller_manager</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Double-click on a controller or hardware component to show the additional info.</p></li>
<li><p>Right-click on a controller or hardware component to show a context menu with options for lifecycle management.</p></li>
</ul>
</section>
<section id="using-the-controller-manager-in-a-process">
<h2>Using the Controller Manager in a Process<a class="headerlink" href="#using-the-controller-manager-in-a-process" title="Permalink to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ControllerManager</span></code> may also be instantiated in a process as a class, but proper care must be taken when doing so.
The reason for this is because the <code class="docutils literal notranslate"><span class="pre">ControllerManager</span></code> class inherits from <code class="docutils literal notranslate"><span class="pre">rclcpp::Node</span></code>.</p>
<p>If there is more than one Node in the process, global node name remap rules can forcibly change the <code class="docutils literal notranslate"><span class="pre">ControllerManager's</span></code> node name as well, leading to duplicate node names.
This occurs whether the Nodes are siblings or exist in a hierarchy.</p>
<img alt="../../../_images/global_general_remap.png" src="../../../_images/global_general_remap.png" />
<p>The workaround for this is to specify another node name remap rule in the <code class="docutils literal notranslate"><span class="pre">NodeOptions</span></code> passed to the <code class="docutils literal notranslate"><span class="pre">ControllerManager</span></code> node (causing it to ignore the global rule), or ensure that any remap rules are targeted to specific nodes.</p>
<img alt="../../../_images/global_specific_remap.png" src="../../../_images/global_specific_remap.png" />
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">controller_manager</span><span class="o">::</span><span class="n">get_cm_node_options</span><span class="p">();</span>
<span class="w">  </span><span class="n">options</span><span class="p">.</span><span class="n">arguments</span><span class="p">({</span>
<span class="w">    </span><span class="s">&quot;--ros-args&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;--remap&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_target_node_name:__node:=dst_node_name&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;--log-level&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;info&quot;</span><span class="p">});</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">cm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">controller_manager</span><span class="o">::</span><span class="n">ControllerManager</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">executor</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_target_node_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;some_optional_namespace&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="launching-controller-manager-with-ros2-control-node">
<h2>Launching controller_manager with ros2_control_node<a class="headerlink" href="#launching-controller-manager-with-ros2-control-node" title="Permalink to this heading"></a></h2>
<p>The controller_manager can be launched with the ros2_control_node executable. The following example shows how to launch the controller_manager with the ros2_control_node executable:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">control_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="s2">&quot;controller_manager&quot;</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;ros2_control_node&quot;</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">robot_controllers</span><span class="p">],</span>
    <span class="n">output</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The ros2_control_node executable uses the following parameters from the <code class="docutils literal notranslate"><span class="pre">controller_manager</span></code> node:</p>
<dl class="simple">
<dt>lock_memory (optional; bool; default: false for a non-realtime kernel, true for a realtime kernel)</dt><dd><p>Locks the memory of the <code class="docutils literal notranslate"><span class="pre">controller_manager</span></code> node at startup to physical RAM in order to avoid page faults
and to prevent the node from being swapped out to disk.
Find more information about the setup for memory locking in the following link : <a class="reference external" href="https://access.redhat.com/solutions/61334">How to set ulimit values</a>
The following command can be used to set the memory locking limit temporarily : <code class="docutils literal notranslate"><span class="pre">ulimit</span> <span class="pre">-l</span> <span class="pre">unlimited</span></code>.</p>
</dd>
<dt>cpu_affinity (optional; int (or) int_array;)</dt><dd><p>Sets the CPU affinity of the <code class="docutils literal notranslate"><span class="pre">controller_manager</span></code> node to the specified CPU core.
If it is an integer, the node’s affinity will be set to the specified CPU core.
If it is an array of integers, the node’s affinity will be set to the specified set of CPU cores.</p>
</dd>
<dt>thread_priority (optional; int; default: 50)</dt><dd><p>Sets the thread priority of the <code class="docutils literal notranslate"><span class="pre">controller_manager</span></code> node to the specified value. The value must be between 0 and 99.</p>
</dd>
<dt>use_sim_time (optional; bool; default: false)</dt><dd><p>Enables the use of simulation time in the <code class="docutils literal notranslate"><span class="pre">controller_manager</span></code> node.</p>
</dd>
</dl>
</section>
<section id="concepts">
<h2>Concepts<a class="headerlink" href="#concepts" title="Permalink to this heading"></a></h2>
<section id="restarting-all-controllers">
<h3>Restarting all controllers<a class="headerlink" href="#restarting-all-controllers" title="Permalink to this heading"></a></h3>
<p>The simplest way to restart all controllers is by using <code class="docutils literal notranslate"><span class="pre">switch_controllers</span></code> services or CLI and adding all controllers to <code class="docutils literal notranslate"><span class="pre">start</span></code> and <code class="docutils literal notranslate"><span class="pre">stop</span></code> lists.
Note that not all controllers have to be restarted, e.g., broadcasters.</p>
</section>
<section id="restarting-hardware">
<h3>Restarting hardware<a class="headerlink" href="#restarting-hardware" title="Permalink to this heading"></a></h3>
<p>If hardware gets restarted then you should go through its lifecycle again in order to reconfigure and export the interfaces</p>
</section>
<section id="hardware-and-controller-errors">
<h3>Hardware and Controller Errors<a class="headerlink" href="#hardware-and-controller-errors" title="Permalink to this heading"></a></h3>
<p>If the hardware during it’s <code class="docutils literal notranslate"><span class="pre">read</span></code> or <code class="docutils literal notranslate"><span class="pre">write</span></code> method returns <code class="docutils literal notranslate"><span class="pre">return_type::ERROR</span></code>, the controller manager will stop all controllers that are using the hardware’s command and state interfaces.
Likewise, if a controller returns <code class="docutils literal notranslate"><span class="pre">return_type::ERROR</span></code> from its <code class="docutils literal notranslate"><span class="pre">update</span></code> method, the controller manager will deactivate the respective controller. In future, the controller manager will try to start any fallback controllers if available.</p>
</section>
<section id="support-for-asynchronous-updates">
<h3>Support for Asynchronous Updates<a class="headerlink" href="#support-for-asynchronous-updates" title="Permalink to this heading"></a></h3>
<p>For some applications, it is desirable to run a controller at a lower frequency than the controller manager’s update rate. For instance, if the <code class="docutils literal notranslate"><span class="pre">update_rate</span></code> for the controller manager is 100Hz, the sum of the execution times of all controllers’ <code class="docutils literal notranslate"><span class="pre">update</span></code> calls and hardware components <code class="docutils literal notranslate"><span class="pre">read</span></code> and <code class="docutils literal notranslate"><span class="pre">write</span></code> calls must be below 10ms. If one controller requires 15ms of execution time, it cannot be executed synchronously without affecting the overall system update rate. Running a controller asynchronously can be beneficial in this scenario.</p>
<p>The async update support is transparent to each controller implementation. A controller can be enabled for asynchronous updates by setting the <code class="docutils literal notranslate"><span class="pre">is_async</span></code> parameter to <code class="docutils literal notranslate"><span class="pre">true</span></code>. The controller manager will load the controller accordingly. For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">controller_manager</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ros__parameters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">update_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span><span class="w">  </span><span class="c1"># Hz</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>

<span class="nt">example_async_controller</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ros__parameters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example_controller/ExampleAsyncController</span>
<span class="w">    </span><span class="nt">is_async</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">update_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span><span class="w">  </span><span class="c1"># Hz</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</pre></div>
</div>
<p>will result in the controller being loaded and configured to run at 20Hz, while the controller manager runs at 100Hz. The description of the parameters can be found in the <a class="reference external" href="https://control.ros.org/master/doc/ros2_controllers/doc/controllers_index.html#common-controller-parameters">Common Controller Parameters</a> section of the ros2_controllers documentation.</p>
</section>
</section>
<section id="scheduling-behavior">
<h2>Scheduling Behavior<a class="headerlink" href="#scheduling-behavior" title="Permalink to this heading"></a></h2>
<p>From a design perspective, the controller manager functions as a scheduler that triggers updates for asynchronous controllers during the control loop.</p>
<p>In this case, the <code class="docutils literal notranslate"><span class="pre">ControllerInterfaceBase</span></code> calls <code class="docutils literal notranslate"><span class="pre">AsyncFunctionHandler</span></code> to handle the actual <code class="docutils literal notranslate"><span class="pre">update</span></code> callback of the controller, which is the same mechanism used by the resource manager to support read/write operations for asynchronous hardware. When a controller is configured to run asynchronously, the controller interface creates an async handler during the controller’s configuration and binds it to the controller’s update method. The async handler thread created by the controller interface has either the same thread priority as the controller manager or the priority specified by the <code class="docutils literal notranslate"><span class="pre">thread_priority</span></code> parameter. When triggered by the controller manager, the async handler evaluates if the previous trigger is successfully finished and then calls the update method.</p>
<p>If the update takes significant time and another update is triggered while the previous update is still running, the result of the previous update will be used. When this situation occurs, the controller manager will print a missing update cycle message, informing the user that they need to lower their controller’s frequency as the computation is taking longer than initially estimated, as shown in the following example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[ros2_control_node-1] [WARN] [1741626670.311533972] [example_async_controller]: The controller missed xx update cycles out of yy total triggers.</span>
</pre></div>
</div>
<p>If the async controller’s update method throws an unhandled exception, the controller manager will handle it the same way as the synchronous controllers, deactivating the controller. It will also print an error message, similar to the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[ros2_control_node-1] [ERROR] [1741629098.352771957] [AsyncFunctionHandler]: AsyncFunctionHandler: Exception caught in the async callback thread!</span>
<span class="go">...</span>
<span class="go">[ros2_control_node-1] [ERROR] [1741629098.352874151] [controller_manager]: Caught exception of type : St13runtime_error while updating controller</span>
<span class="go">[ros2_control_node-1] [ERROR] [1741629098.352940701] [controller_manager]: Deactivating controllers : [example_async_controller] as their update resulted in an error!</span>
</pre></div>
</div>
</section>
<section id="monitoring-and-tuning">
<h2>Monitoring and Tuning<a class="headerlink" href="#monitoring-and-tuning" title="Permalink to this heading"></a></h2>
<p>ros2_control <code class="docutils literal notranslate"><span class="pre">controller_interface</span></code> has a <code class="docutils literal notranslate"><span class="pre">ControllerUpdateStats</span></code> structure which can be used to monitor the controller update rate and the missed update cycles. The data is published to the <code class="docutils literal notranslate"><span class="pre">/diagnostics</span></code> topic. This can be used to fine tune the controller update rate.</p>
<section id="different-clocks-used-by-controller-manager">
<h3>Different Clocks used by Controller Manager<a class="headerlink" href="#different-clocks-used-by-controller-manager" title="Permalink to this heading"></a></h3>
<p>The controller manager internally uses the following two different clocks for a non-simulation setup:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">RCL_ROS_TIME</span></code>: This clock is used mostly in the non-realtime loops.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RCL_STEADY_TIME</span></code>: This clock is used mostly in the realtime loops for the <code class="docutils literal notranslate"><span class="pre">read</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code>, and <code class="docutils literal notranslate"><span class="pre">write</span></code> loops. However, when the controller manager is used in a simulation environment, the <code class="docutils literal notranslate"><span class="pre">RCL_ROS_TIME</span></code> clock is used for triggering the <code class="docutils literal notranslate"><span class="pre">read</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code>, and <code class="docutils literal notranslate"><span class="pre">write</span></code> loops.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">time</span></code> argument in the <code class="docutils literal notranslate"><span class="pre">read</span></code> and <code class="docutils literal notranslate"><span class="pre">write</span></code> methods of the hardware components is of type <code class="docutils literal notranslate"><span class="pre">RCL_STEADY_TIME</span></code>, as most of the hardware expects the time to be monotonic and not affected by the system time changes. However, the <code class="docutils literal notranslate"><span class="pre">time</span></code> argument in the <code class="docutils literal notranslate"><span class="pre">update</span></code> method of the controller is of type <code class="docutils literal notranslate"><span class="pre">RCL_ROS_TIME</span></code> as the controller is the one that interacts with other nodes or topics to receive the commands or publish the state. This <code class="docutils literal notranslate"><span class="pre">time</span></code> argument can be used by the controllers to validate the received commands or to publish the state at the correct timestamp.
The <code class="docutils literal notranslate"><span class="pre">period</span></code> argument in the <code class="docutils literal notranslate"><span class="pre">read</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code> and <code class="docutils literal notranslate"><span class="pre">write</span></code> methods is calculated using the trigger clock of type <code class="docutils literal notranslate"><span class="pre">RCL_STEADY_TIME</span></code> so it is always monotonic.</p>
<p>The reason behind using different clocks is to avoid the issues related to the affect of system time changes in the realtime loops. The <code class="docutils literal notranslate"><span class="pre">ros2_control_node</span></code> now also detects the overruns caused by the system time changes and longer execution times of the controllers and hardware components. The controller manager will print a warning message if the controller or hardware component misses the update cycle due to the system time changes or longer execution times.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Franka Robotics GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>